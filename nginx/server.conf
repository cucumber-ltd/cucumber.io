# X-Proxy-Pass: xyz headers are added for testing purposes
server {
    # $PORT is changed at run time so that Heroku's dynamic port can be assigned.
    listen $PORT;
    server_name cucumber.io;

    # --------------- #
    # BLOG            #
    # --------------- #
    # The blog is setup through a provider named Ghost. With the way links used to be setup and
    # some issues in migration, there's some rewrite fixes in place to help remove undesirable 404s
    # users may run into.

    # fix broken slug urls & rewrite old blog urls that have dates in the path
    rewrite ^blog/introducing-example-mapping$                        $scheme://$http_host/blog/example-mapping-introduction permanent;
    rewrite ^/blog/introducing-example-mapping/$                      $scheme://$http_host/blog/example-mapping-introduction permanent;
    rewrite ^/are-you-doing-bdd-or-are-you-just-using-cucumber/$      $scheme://$http_host/blog/single-source-of-truth/ permanent;
    rewrite ^/blog/are-you-doing-bdd-or-are-you-just-using-cucumber/$ $scheme://$http_host/blog/single-source-of-truth/ permanent;
    rewrite ^/blog/2016/09/13/cucumber-jvm-1\.2\.5/$                  $scheme://$http_host/blog/cucumber-jvm-1-2-5 permanent;
    rewrite ^/blog/cucumber-jvm-1\.2\.5/$                             $scheme://$http_host/blog/cucumber-jvm-1-2-5 permanent;
    rewrite ^/blog/2015/09/11/cucumber-2\.1/$                         $scheme://$http_host/blog/cucumber-2-1 permanent;
    rewrite ^/blog/cucumber-2\.1/$                                    $scheme://$http_host/blog/cucumber-2-1 permanent;
    rewrite ^/blog/(?:[0-9]+)\/(?:[0-9]+)\/(?:[0-9]+)(.*)$            $scheme://$http_host/blog$1 permanent;

    location = /blog {
         proxy_set_header Host cucumber.ghost.io;
         proxy_pass  https://cucumber.ghost.io/;
         add_header X-Proxy-Pass https://cucumber.ghost.io/blog/;
    }
    
    location = /blog/ {
         proxy_set_header Host cucumber.ghost.io;
         proxy_pass  https://cucumber.ghost.io/;
         add_header X-Proxy-Pass https://cucumber.ghost.io/blog/;
    }

    # proxy the posts as linked from /blog
    location ~ ^/blog/(.*)$ {
         proxy_set_header Host cucumber.ghost.io;
         proxy_pass  https://cucumber.ghost.io/blog/$1;
         add_header X-Proxy-Pass https://cucumber.ghost.io/blog/$1;
    }

    # proxy relative logo url
    location ~ ^/(content/images/2019/02/cucumber-black-512.png)$ {
         proxy_set_header Host cucumber.ghost.io;
         proxy_pass  https://cucumber.ghost.io/$1;
         add_header X-Proxy-Pass https://cucumber.ghost.io/blog/$1;
    }

    # proxy tag routes
    location ~ ^/(tag|author|page)(.*)$ {
         proxy_set_header Host cucumber.ghost.io;
         proxy_pass  https://cucumber.ghost.io/$1$2;
         add_header X-Proxy-Pass https://cucumber.ghost.io/$1$2;
     }

    # blog favicon
    location = /favicon.png {
         proxy_set_header Host cucumber.ghost.io;
         proxy_pass  https://cucumber.ghost.io/favicon.png;
    }

    # --------------- #
    # DOCS            #
    # --------------- #
    # The docs page is a Hugo static site hosted on Netlify.

    location = /docs {
        proxy_set_header  Host  cucumber.netlify.com;
        proxy_pass        https://cucumber.netlify.com/;
        add_header X-Proxy-Pass https://cucumber.netlify.com/;
    }

    location ~  ^/(css|js|img|installation|guides|bdd|gherkin|cucumber|tools|community|professional|team)(.*)$ {
        proxy_set_header  Host    cucumber.netlify.com;
        proxy_pass       https://cucumber.netlify.com/$1$2;
        add_header X-Proxy-Pass https://cucumber.netlify.com/$1$2;
    }

    # --------------- #
    # JAM             #
    # --------------- #
    # Jam's homepage lives on Convert Flow for generating sales.

    location /jam {
        proxy_set_header  Host                jam.convertflowpages.com;
        proxy_pass        https://jam.convertflowpages.com/sales;
        proxy_ssl_server_name on;
        add_header X-Proxy-Pass https://jam.convertflowpages.com/sales;
    }
    
    # Rewrite pro to jam to be consistent branding.
    rewrite ^/pro$ $scheme://$http_host/jam permanent;

    # --------------- #
    # SQAURESPACE     #
    # --------------- #
    # Squarespace is where the blog's homepage lives along with additional supporting pages like
    # events, training, and school.*
    # *Training and school haven't been moved yet

    location / {
        proxy_set_header  Host                cucumber-website.squarespace.com;
        proxy_pass        https://cucumber-website.squarespace.com;
        proxy_http_version 1.1;
        add_header X-Proxy-Pass https://cucumber-website.squarespace.com;
    }

    location = /assets/ui-icons.svg {
        proxy_set_header  Host    cucumber-website.squarespace.com;
        proxy_pass        https://cucumber-website.squarespace.com/assets/ui-icons.svg;
        proxy_http_version 1.1;
        add_header X-Proxy-Pass https://cucumber-website.squarespace.com;
    }

    rewrite ^/events/bdd-kickstart-boston-2018 /events/2018/10/31/bdd-kickstart-boston permanent;
    rewrite ^/events/bdd-kickstart-austin-18   /events/2018/10/18/bdd-kickstart-austin permanent;
    rewrite ^/events/bdd-kickstart-paris       /events/2018/10/11/bdd-kickstart-paris  permanent;
    rewrite ^/events/cukenspace-usa            /events/2018/12/12/cukenspace-charlotte permanent;

    # redirect initials to homepage for tracking business cards¬
    # we may want to create personal pages thanking people for chatting with us¬
    # at these urls¬
    rewrite ^/(ah|jb|mw|sr|st|tsr|rm)$      /;

    # --------------- #
    # MISC/OLD        #
    # --------------- #
    # Miscellaneous routes and/or routes from the old website. These will be cleaned up as old site
    # is decommissioned. 

    # redirect old Ruby API links
    rewrite ^/api/cucumber/ruby/yardoc(.*)$ http://www.rubydoc.info/github/cucumber/cucumber-ruby$1 permanent;
    rewrite ^/cucumber/api/ruby/latest(.*)$ http://www.rubydoc.info/github/cucumber/cucumber-ruby$1 permanent;

    # podcast feed
    rewrite ^/podcast/feed.xml$             http://feeds.soundcloud.com/users/soundcloud:users:181591133/sounds.rss;

    # Old Ruby / Rack app on heroku
    location ~ ^/(school|training|talks|team|pro|privacy|logo-contest|contact-preferences|feed.xml)(.*)$ {
        proxy_set_header  Host    cucumber-website.herokuapp.com;
        proxy_pass        http://cucumber-website.herokuapp.com/$1$2;
    }

    # old events pages (new ones on squarespace start with the year in their url)
    # we think we need to keep these for SEO
    location ~ ^/(events/[a-z].*) {
        proxy_set_header  Host    cucumber-website.herokuapp.com;
        proxy_pass        http://cucumber-website.herokuapp.com/$1;
    }

    # assets used by the old Ruby / Rack app pages
    location ~ ^/(assets|images|fonts)(.*)$ {
        proxy_set_header  Host    cucumber-website.herokuapp.com;
        proxy_pass        http://cucumber-website.herokuapp.com/$1$2;
    }
}
